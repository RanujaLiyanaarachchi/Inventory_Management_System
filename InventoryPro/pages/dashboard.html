<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InventoryPro - Dashboard</title>
  <!-- Authentication Guard Script - Must be loaded first -->
  <script>
    (function() {
      'use strict';
      
      // Check authentication immediately when script loads
      function checkAuthentication() {
        const userSession = localStorage.getItem("userSession") || sessionStorage.getItem("userSession");
        const authToken = localStorage.getItem("authToken") || sessionStorage.getItem("authToken");
        const selectedRole = localStorage.getItem("selectedRole");
        
        if (!userSession || !authToken || !selectedRole) {
          console.log("No authentication found, redirecting to selection page");
          window.location.href = "selection.html";
          return false;
        }
        
        try {
          const sessionData = JSON.parse(userSession);
          if (!sessionData.authenticated || !sessionData.userId || !sessionData.email) {
            throw new Error("Invalid session data");
          }
          return true;
        } catch (error) {
          console.log("Invalid session data:", error.message);
          localStorage.removeItem("userSession");
          localStorage.removeItem("authToken");
          sessionStorage.removeItem("userSession");
          sessionStorage.removeItem("authToken");
          window.location.href = "selection.html";
          return false;
        }
      }
      
      // Check authentication when page loads
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkAuthentication);
      } else {
        checkAuthentication();
      }
    })();
  </script>
  
  <!-- Local File Access Detection and Setup -->
  <script>
    // Check if running on file:// protocol and show setup guide
    (function() {
      const isFileProtocol = window.location.protocol === 'file:';
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      
      if (isFileProtocol) {
        console.warn('üö® Running on file:// protocol. Setting up local file access handlers...');
        
        // Set global flag for file protocol mode
        window.FILE_PROTOCOL_MODE = true;
        
        // Add setup banner
        document.addEventListener('DOMContentLoaded', function() {
          showFileProtocolBanner();
        });
      } else if (isLocalhost) {
        console.log('‚úÖ Running on local server. Full functionality available.');
        window.FILE_PROTOCOL_MODE = false;
      }
      
      function showFileProtocolBanner() {
        const banner = document.createElement('div');
        banner.id = 'fileProtocolBanner';
        banner.innerHTML = `
          <div style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-size: 0.875rem;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border-bottom: 2px solid rgba(255,255,255,0.3);
          ">
            <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-exclamation-triangle" style="color: #f39c12; animation: pulse 2s infinite;"></i>
                <strong>File Protocol Mode:</strong> Some features may not work. 
                <a href="#" onclick="showSetupModal()" style="color: #ecf0f1; text-decoration: underline; margin-left: 0.5rem;">Setup Local Server</a>
              </div>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <button onclick="enableFileMode()" style="
                  background: rgba(255,255,255,0.2);
                  border: 1px solid rgba(255,255,255,0.3);
                  color: white;
                  padding: 0.25rem 0.75rem;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.75rem;
                ">Continue Anyway</button>
                <button onclick="document.getElementById('fileProtocolBanner').remove()" style="
                  background: none;
                  border: none;
                  color: white;
                  font-size: 1rem;
                  cursor: pointer;
                  opacity: 0.8;
                ">√ó</button>
              </div>
            </div>
          </div>
          
          <style>
            @keyframes pulse {
              0% { opacity: 1; }
              50% { opacity: 0.5; }
              100% { opacity: 1; }
            }
          </style>
        `;
        document.body.appendChild(banner);
        
        // Adjust body padding to account for banner
        document.body.style.paddingTop = '60px';
      }
    })();
  </script>
  
  <link rel="stylesheet" href="../app.css">
  <link rel="stylesheet" href="dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<<<<<<< HEAD
  <!-- Setup Modal -->
  <div id="setupModal" style="display: none;">
    <div style="
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    ">
      <div style="
        background: #2c3e50;
        border-radius: 12px;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        color: white;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      ">
        <div style="padding: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #3498db; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-server"></i>
              Local Server Setup Guide
            </h2>
            <button onclick="closeSetupModal()" style="
              background: none;
              border: none;
              color: white;
              font-size: 1.5rem;
              cursor: pointer;
              opacity: 0.7;
            ">√ó</button>
          </div>
        </div>
=======
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/>
                        <path d="M12 17.5L6.5 12H10v-2h4v2h3.5L12 17.5zM8 7h8v2H8z"/>
                    </svg>
                    InventoryPro
                </div>
            </div>
            
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="../pages/dashboard.html" class="nav-link active">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                        </svg>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                        </svg>
                        Suppliers
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M19 5v2h-4V5h4M9 5v6H5V5h4m10 8v6h-4v-6h4M9 17v2H5v-2h4M21 3h-8v6h8V3zM11 3H3v10h8V3zm10 8h-8v10h8V11zm-10 4H3v6h8v-6z"/>
                        </svg>
                        Products
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                        </svg>
                        Categories
                    </a>
                </li>
                <li class="nav-item">
                    <a href="../pages/stock.html" class="nav-link">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 18H6V4h2v8l2.5-1.5L13 12V4h5v16z"/>
                        </svg>
                        Stocks
                    </a>
                </li>
                <li class="nav-item">
                    <a href="../pages/grn.html" class="nav-link">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M13 13v8h8v-8h-8zM3 21h8v-8H3v8zM3 3v8h8V3H3zm13.66-1.31L11 7.34 16.66 13l5.66-5.66-5.66-5.65z"/>
                        </svg>
                        GRN
                    </a>
                </li>
                <li class="nav-item">
                    <a href="../pages/users.html" class="nav-link">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                        </svg>
                        Users
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
                        </svg>
                        Invoices
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Return Invoices
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
                        </svg>
                        Promotions
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                        </svg>
                        Settings
                    </a>
                </li>
            </ul>
        </aside>
>>>>>>> c463acc6194cf13ad772fbf4d5be05396cbb9b99
        
        <div style="padding: 2rem;">
          <div style="margin-bottom: 2rem;">
            <h3 style="color: #e74c3c; margin-bottom: 1rem;">‚ö†Ô∏è Current Issue</h3>
            <p style="color: #bdc3c7; line-height: 1.6; margin-bottom: 1rem;">
              You're running InventoryPro directly from files (file:// protocol). Modern browsers block loading of external files for security, which prevents pages like Suppliers, Products, etc. from working properly.
            </p>
          </div>
          
          <div style="margin-bottom: 2rem;">
            <h3 style="color: #2ecc71; margin-bottom: 1rem;">‚úÖ Solutions</h3>
            
            <!-- VS Code Live Server -->
            <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(52, 152, 219, 0.1); border-radius: 8px; border-left: 4px solid #3498db;">
              <h4 style="color: #3498db; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fab fa-microsoft"></i>
                Option 1: VS Code Live Server (Recommended)
              </h4>
              <ol style="color: #bdc3c7; margin: 0; padding-left: 1.5rem; line-height: 1.6;">
                <li>Open VS Code</li>
                <li>Install "Live Server" extension by Ritwick Dey</li>
                <li>Right-click on <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">dashboard.html</code></li>
                <li>Select "Open with Live Server"</li>
                <li>Your app will open at <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">http://127.0.0.1:5500</code></li>
              </ol>
            </div>
            
            <!-- Python Server -->
            <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(46, 204, 113, 0.1); border-radius: 8px; border-left: 4px solid #2ecc71;">
              <h4 style="color: #2ecc71; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fab fa-python"></i>
                Option 2: Python Server
              </h4>
              <ol style="color: #bdc3c7; margin: 0; padding-left: 1.5rem; line-height: 1.6;">
                <li>Open Command Prompt/Terminal in project folder</li>
                <li>Run: <code style="background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 3px; font-family: monospace;">python -m http.server 8000</code></li>
                <li>Open: <code style="background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 3px; font-family: monospace;">http://localhost:8000/pages/dashboard.html</code></li>
              </ol>
            </div>
            
            <!-- Node.js Server -->
            <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(155, 89, 182, 0.1); border-radius: 8px; border-left: 4px solid #9b59b6;">
              <h4 style="color: #9b59b6; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fab fa-node-js"></i>
                Option 3: Node.js Server
              </h4>
              <ol style="color: #bdc3c7; margin: 0; padding-left: 1.5rem; line-height: 1.6;">
                <li>Install: <code style="background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 3px; font-family: monospace;">npm install -g http-server</code></li>
                <li>Run: <code style="background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 3px; font-family: monospace;">http-server -p 8000</code></li>
                <li>Open: <code style="background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 3px; font-family: monospace;">http://localhost:8000/pages/dashboard.html</code></li>
              </ol>
            </div>
          </div>
          
          <div style="text-align: center; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <button onclick="enableFileMode(); closeSetupModal();" style="
              background: #e74c3c;
              color: white;
              border: none;
              padding: 0.75rem 2rem;
              border-radius: 6px;
              cursor: pointer;
              font-size: 0.875rem;
              margin-right: 1rem;
            ">Continue with Limited Features</button>
            <button onclick="closeSetupModal()" style="
              background: #34495e;
              color: white;
              border: none;
              padding: 0.75rem 2rem;
              border-radius: 6px;
              cursor: pointer;
              font-size: 0.875rem;
            ">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <i class="fas fa-boxes-stacked"></i>
        <span class="logo-text">Inventory<span>Pro</span></span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <ul class="nav-list">
        <li class="nav-item active" data-page="dashboard">
          <a href="#" class="nav-link">
            <i class="fas fa-chart-pie"></i>
            <span class="nav-text">Dashboard</span>
          </a>
        </li>
        <li class="nav-item" data-page="suppliers">
          <a href="#" class="nav-link">
            <i class="fas fa-truck"></i>
            <span class="nav-text">Suppliers</span>
          </a>
        </li>
        <li class="nav-item" data-page="products">
          <a href="#" class="nav-link">
            <i class="fas fa-box"></i>
            <span class="nav-text">Products</span>
          </a>
        </li>
        <li class="nav-item" data-page="categories">
          <a href="#" class="nav-link">
            <i class="fas fa-tags"></i>
            <span class="nav-text">Categories</span>
          </a>
        </li>
        <li class="nav-item" data-page="stocks">
          <a href="#" class="nav-link">
            <i class="fas fa-warehouse"></i>
            <span class="nav-text">Stocks</span>
          </a>
        </li>
        <li class="nav-item" data-page="users">
          <a href="#" class="nav-link">
            <i class="fas fa-users"></i>
            <span class="nav-text">Users</span>
          </a>
        </li>
        <li class="nav-item" data-page="invoices">
          <a href="#" class="nav-link">
            <i class="fas fa-file-invoice"></i>
            <span class="nav-text">Invoices</span>
          </a>
        </li>
        <li class="nav-item" data-page="return-invoices">
          <a href="#" class="nav-link">
            <i class="fas fa-undo"></i>
            <span class="nav-text">Return Invoices</span>
          </a>
        </li>
        <li class="nav-item" data-page="promotions">
          <a href="#" class="nav-link">
            <i class="fas fa-percentage"></i>
            <span class="nav-text">Promotions</span>
          </a>
        </li>
        <li class="nav-item" data-page="settings">
          <a href="#" class="nav-link">
            <i class="fas fa-cog"></i>
            <span class="nav-text">Settings</span>
          </a>
        </li>
      </ul>
    </nav>

    <div class="sidebar-footer">
      <div class="user-profile">
        <div class="user-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="user-info">
          <span class="user-name" id="userName">Loading...</span>
          <span class="user-role" id="userRole">Loading...</span>
        </div>
      </div>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
        <span class="nav-text">Logout</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content" id="mainContent">
    <!-- Header (Hidden for dashboard) -->
    <header class="main-header" id="mainHeader">
      <div class="header-left">
        <h1 class="page-title" id="pageTitle">Dashboard</h1>
      </div>
      <div class="header-right">
        <!-- Header right content can be added here if needed -->
      </div>
    </header>

    <!-- Content Area -->
    <div class="content-area" id="contentArea">
      <!-- Dashboard Welcome Screen -->
      <div class="page-content" id="dashboardContent">
        <div class="dashboard-welcome">
          <div class="welcome-content">
            <div class="welcome-message">
              <h2 class="welcome-title">Welcome to InventoryPro</h2>
              <p class="welcome-subtitle">Manage your inventory efficiently and effectively</p>
            </div>
            
            <!-- Centered DateTime Display -->
            <div class="datetime-center-display" id="datetimeCenterDisplay">
              <div class="time-container">
                <div class="current-time-large" id="currentTimeLarge"></div>
                <div class="current-date-large" id="currentDateLarge"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dynamic Content will be loaded here -->
      <div class="page-content hidden" id="dynamicContent">
        <!-- External page content will be loaded here -->
      </div>
    </div>
  </main>

  <script type="module">
    // Import Firebase modules for authentication
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBKjE2SmRvgQczTmcKZrEFD0pyjLBMD4gg",
      authDomain: "inventorypro-lk.firebaseapp.com",
      projectId: "inventorypro-lk",
      storageBucket: "inventorypro-lk.firebasestorage.app",
      messagingSenderId: "594998429191",
      appId: "1:594998429191:web:518f4b7f88eb7c0a2d0ca2",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Global variables
    window.FILE_MODE_ENABLED = false;

    // Check authentication on page load
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthentication();
      initializeDashboard();
      updateDateTime();
      setInterval(updateDateTime, 1000);
    });

    function checkAuthentication() {
      const userSession = localStorage.getItem("userSession") || sessionStorage.getItem("userSession");
      
      if (!userSession) {
        window.location.href = "selection.html";
        return false;
      }

      try {
        const sessionData = JSON.parse(userSession);
        document.getElementById('userName').textContent = sessionData.displayName || sessionData.email.split('@')[0];
        document.getElementById('userRole').textContent = sessionData.roleName || sessionData.role;
        return true;
      } catch (error) {
        console.error("Invalid session data:", error);
        window.location.href = "selection.html";
        return false;
      }
    }

    function initializeDashboard() {
      const navItems = document.querySelectorAll('.nav-item');
      
      navItems.forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Remove active class from all items
          navItems.forEach(navItem => navItem.classList.remove('active'));
          
          // Add active class to clicked item
          this.classList.add('active');
          
          const page = this.getAttribute('data-page');
          loadPage(page);
        });
      });
    }

    function loadPage(page) {
      const pageTitle = document.getElementById('pageTitle');
      const mainHeader = document.getElementById('mainHeader');
      const dashboardContent = document.getElementById('dashboardContent');
      const dynamicContent = document.getElementById('dynamicContent');
      
      // Update page title
      pageTitle.textContent = page.charAt(0).toUpperCase() + page.slice(1).replace('-', ' ');
      
      if (page === 'dashboard') {
        // Hide header for dashboard and show dashboard content
        mainHeader.classList.add('hidden');
        dashboardContent.classList.remove('hidden');
        dynamicContent.classList.add('hidden');
      } else {
        // Show header for other pages
        mainHeader.classList.remove('hidden');
        // Hide dashboard content and show dynamic content
        dashboardContent.classList.add('hidden');
        dynamicContent.classList.remove('hidden');
        
        // Load external page
        loadExternalPage(page);
      }
    }

    async function loadExternalPage(page) {
      const dynamicContent = document.getElementById('dynamicContent');
      
      // Show loading state
      dynamicContent.innerHTML = createLoadingHTML(page);
      
      console.log(`üîÑ Loading ${page} page...`);
      
      const isFileProtocol = window.location.protocol === 'file:';
      
      // If in file mode and not enabled, show setup instead
      if (isFileProtocol && !window.FILE_MODE_ENABLED) {
        showSetupRequiredMessage(page);
        return;
      }
      
      try {
        let content = '';
        
        if (isFileProtocol && window.FILE_MODE_ENABLED) {
          // File protocol mode - use embedded content
          content = await loadEmbeddedContent(page);
        } else {
          // Server mode - load external files
          content = await loadExternalFile(page);
        }
        
        if (content) {
          dynamicContent.innerHTML = content;
          loadPageCSS(page);
          
          setTimeout(() => {
            executePageScripts(dynamicContent);
            setTimeout(() => {
              initializePageSpecificFeatures(page);
            }, 100);
          }, 50);
          
          console.log(`üéâ ${page} page loaded successfully`);
        } else {
          throw new Error('No content available');
        }
        
      } catch (error) {
        console.error(`‚ùå Error loading ${page}:`, error);
        showErrorMessage(page, error);
      }
    }

    async function loadExternalFile(page) {
      const possiblePaths = [
        `${page}.html`,
        `./${page}.html`,
        `./pages/${page}.html`,
        `../${page}.html`
      ];
      
      for (const path of possiblePaths) {
        try {
          console.log(`üìÇ Trying path: ${path}`);
          const response = await fetch(path);
          if (response.ok) {
            const html = await response.text();
            console.log(`‚úÖ Found at: ${path}`);
            
            // Parse and extract content
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            return doc.body && doc.body.innerHTML.trim() ? doc.body.innerHTML : html;
          }
        } catch (err) {
          console.log(`‚ùå Failed path: ${path} - ${err.message}`);
          continue;
        }
      }
      
      throw new Error('File not found in any attempted paths');
    }

    async function loadEmbeddedContent(page) {
      // Embedded content for file protocol mode
      const embeddedContent = {
        suppliers: createSuppliersContent(),
        products: createProductsContent(),
        categories: createCategoriesContent(),
        stocks: createStocksContent(),
        users: createUsersContent(),
        invoices: createInvoicesContent(),
        'return-invoices': createReturnInvoicesContent(),
        promotions: createPromotionsContent(),
        settings: createSettingsContent()
      };
      
      return embeddedContent[page] || createPlaceholderContent(page);
    }

    function createLoadingHTML(page) {
      return `
        <div style="display: flex; justify-content: center; align-items: center; height: 200px; color: #fff;">
          <div style="text-align: center;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem; color: #3498db;"></i>
            <p>Loading ${page}...</p>
          </div>
        </div>
      `;
    }

    function showSetupRequiredMessage(page) {
      const dynamicContent = document.getElementById('dynamicContent');
      dynamicContent.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; min-height: 400px; color: #e74c3c; padding: 2rem;">
          <div style="text-align: center; max-width: 600px;">
            <i class="fas fa-server" style="font-size: 4rem; margin-bottom: 2rem; color: #f39c12;"></i>
            
            <h2 style="margin-bottom: 1rem; color: #e74c3c;">Local Server Required</h2>
            
            <p style="color: #bdc3c7; margin-bottom: 2rem; line-height: 1.6;">
              The <strong>${page}</strong> page requires a local server to function properly. 
              You're currently running the app directly from files.
            </p>
            
            <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem; flex-wrap: wrap;">
              <button onclick="showSetupModal()" style="
                background: #3498db; 
                color: white; 
                border: none; 
                padding: 0.75rem 1.5rem; 
                border-radius: 6px; 
                cursor: pointer;
                font-size: 0.875rem;
              ">
                <i class="fas fa-cog" style="margin-right: 0.5rem;"></i>
                Setup Local Server
              </button>
              <button onclick="enableFileMode(); loadExternalPage('${page}')" style="
                background: #e74c3c; 
                color: white; 
                border: none; 
                padding: 0.75rem 1.5rem; 
                border-radius: 6px; 
                cursor: pointer;
                font-size: 0.875rem;
              ">
                <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                Continue with Limited Features
              </button>
            </div>
            
            <div style="background: #2c3e50; padding: 1rem; border-radius: 6px; border-left: 4px solid #f39c12;">
              <p style="color: #bdc3c7; font-size: 0.75rem; margin: 0;">
                <i class="fas fa-info-circle" style="margin-right: 0.5rem; color: #f39c12;"></i>
                Use VS Code Live Server for the best experience
              </p>
            </div>
          </div>
        </div>
      `;
    }

    function showErrorMessage(page, error) {
      const dynamicContent = document.getElementById('dynamicContent');
      dynamicContent.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; min-height: 400px; color: #e74c3c; padding: 2rem;">
          <div style="text-align: center; max-width: 600px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1.5rem; color: #f39c12;"></i>
            
            <h3 style="margin-bottom: 1rem; color: #e74c3c;">Failed to Load ${page.charAt(0).toUpperCase() + page.slice(1)}</h3>
            <p style="margin-bottom: 1rem; color: #bdc3c7;">The ${page} page could not be loaded.</p>
            <p style="font-size: 0.875rem; color: #7f8c8d; margin-bottom: 2rem;">${error.message}</p>
            
            <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem; flex-wrap: wrap;">
              <button onclick="loadExternalPage('${page}')" style="
                background: #5865f2; 
                color: white; 
                border: none; 
                padding: 0.75rem 1.5rem; 
                border-radius: 6px; 
                cursor: pointer;
                font-size: 0.875rem;
              ">
                <i class="fas fa-sync-alt" style="margin-right: 0.5rem;"></i>
                Retry
              </button>
              <button onclick="document.querySelector('[data-page=\\"dashboard\\"]').click()" style="
                background: #6c757d; 
                color: white; 
                border: none; 
                padding: 0.75rem 1.5rem; 
                border-radius: 6px; 
                cursor: pointer;
                font-size: 0.875rem;
              ">
                <i class="fas fa-home" style="margin-right: 0.5rem;"></i>
                Back to Dashboard
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Embedded content creators for file protocol mode
    function createSuppliersContent() {
      return `
        <div class="suppliers-container">
          <div class="suppliers-header">
            <div class="header-controls">
              <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search suppliers...">
              </div>
              <select class="filter-select">
                <option value="">All Categories</option>
                <option value="electronics">Electronics</option>
                <option value="clothing">Clothing</option>
                <option value="food">Food & Beverage</option>
                <option value="automotive">Automotive</option>
              </select>
              <select class="filter-select">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
              <button class="btn-add-supplier">
                <i class="fas fa-plus"></i>
                Add Supplier
              </button>
            </div>
          </div>
          
          <div class="table-container">
            <div class="table-wrapper">
              <table class="suppliers-table">
                <thead>
                  <tr>
                    <th>Supplier ID</th>
                    <th>Name</th>
                    <th>Contact Person</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="supplier-id">SUP001</td>
                    <td class="supplier-name">Sample Supplier</td>
                    <td class="contact-person">John Doe</td>
                    <td class="phone">123-456-7890</td>
                    <td class="email">john@example.com</td>
                    <td><span class="category-badge electronics">Electronics</span></td>
                    <td><span class="status-badge active">Active</span></td>
                    <td class="actions">
                      <button class="action-btn view-btn"><i class="fas fa-eye"></i></button>
                      <button class="action-btn edit-btn"><i class="fas fa-edit"></i></button>
                      <button class="action-btn delete-btn"><i class="fas fa-trash"></i></button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <div style="text-align: center; padding: 2rem; color: #f39c12; background: rgba(243, 156, 18, 0.1); margin: 1rem; border-radius: 8px;">
            <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
            <strong>File Protocol Mode:</strong> Limited functionality. Use a local server for full features.
          </div>
        </div>
      `;
    }

    function createProductsContent() {
      return `
        <div style="padding: 2rem; text-align: center; color: #fff;">
          <h2 style="color: #3498db; margin-bottom: 1rem;">Products Management</h2>
          <p style="color: #bdc3c7; margin-bottom: 2rem;">Manage your product inventory</p>
          <div style="background: rgba(52, 152, 219, 0.1); padding: 2rem; border-radius: 8px; border-left: 4px solid #3498db;">
            <i class="fas fa-box" style="font-size: 3rem; color: #3498db; margin-bottom: 1rem;"></i>
            <p style="color: #bdc3c7;">Products functionality will be available here</p>
          </div>
        </div>
      `;
    }

    function createCategoriesContent() {
      return `
        <div style="padding: 2rem; text-align: center; color: #fff;">
          <h2 style="color: #e74c3c; margin-bottom: 1rem;">Categories Management</h2>
          <p style="color: #bdc3c7; margin-bottom: 2rem;">Organize your product categories</p>
          <div style="background: rgba(231, 76, 60, 0.1); padding: 2rem; border-radius: 8px; border-left: 4px solid #e74c3c;">
            <i class="fas fa-tags" style="font-size: 3rem; color: #e74c3c; margin-bottom: 1rem;"></i>
            <p style="color: #bdc3c7;">Categories functionality will be available here</p>
          </div>
        </div>
      `;
    }

    function createStocksContent() {
      return `
        <div style="padding: 2rem; text-align: center; color: #fff;">
          <h2 style="color: #2ecc71; margin-bottom: 1rem;">Stock Management</h2>
          <p style="color: #bdc3c7; margin-bottom: 2rem;">Monitor and manage your inventory levels</p>
          <div style="background: rgba(46, 204, 113, 0.1); padding: 2rem; border-radius: 8px; border-left: 4px solid #2ecc71;">
            <i class="fas fa-warehouse" style="font-size: 3rem; color: #2ecc71; margin-bottom: 1rem;"></i>
            <p style="color: #bdc3c7;">Stock management functionality will be available here</p>
          </div>
        </div>
      `;
    }

    function createUsersContent() {
      return `
        <div style="padding: 2rem; text-align: center; color: #fff;">
          <h2 style="color: #9b59b6; margin-bottom: 1rem;">User Management</h2>
          <p style="color: #bdc3c7; margin-bottom: 2rem;">Manage system users and permissions</p>
          <div style="background: rgba(155, 89, 182, 0.1); padding: 2rem; border-radius: 8px; border-left: 4px solid #9b59b6;">
            <i class="fas fa-users" style="font-size: 3rem; color: #9b59b6; margin-bottom: 1rem;"></i>
            <p style="color: #bdc3c7;">User management functionality will be available here</p>
          </div>
        </div>
      `;
    }

    function createInvoicesContent() {
      return `
        <div style="padding: 2rem; text-align: center; color: #fff;">
          <h2 style="color: #f39c12; margin-bottom: 1rem;">Invoice Management</h2>
          <p style="color: #bdc3c7; margin-bottom: 2rem;">Create and manage invoices</p>
          <div style="background: rgba(243, 156, 18, 0.1); padding: 2rem; border-radius: 8px; border-left: 4px solid #f39c12;">
            <i class="fas fa-file-invoice" style="font-size: 3rem; color: #f39c12; margin-bottom: 1rem;"></i>
            <p style="color: #bdc3c7;">Invoice functionality will be available here</p>
          </div>
        </div>
      `;
    }

    function createReturnInvoicesContent() {
      return `
        <div style="padding: 2rem; text-align: center; color: #fff;">
          <h2 style="color: #e67e22; margin-bottom: 1rem;">Return Invoice Management</h2>
          <p style="color: #bdc3c7; margin-bottom: 2rem;">Handle product returns and refunds</p>
          <div style="background: rgba(230, 126, 34, 0.1); padding: 2rem; border-radius: 8px; border-left: 4px solid #e67e22;">
            <i class="fas fa-undo" style="font-size: 3rem; color: #e67e22; margin-bottom: 1rem;"></i>
            <p style="color: #bdc3c7;">Return invoice functionality will be available here</p>
          </div>
        </div>
      `;
    }

    function createPromotionsContent() {
      return `
        <div style="padding: 2rem; text-align: center; color: #fff;">
          <h2 style="color: #1abc9c; margin-bottom: 1rem;">Promotions Management</h2>
          <p style="color: #bdc3c7; margin-bottom: 2rem;">Create and manage promotional offers</p>
          <div style="background: rgba(26, 188, 156, 0.1); padding: 2rem; border-radius: 8px; border-left: 4px solid #1abc9c;">
            <i class="fas fa-percentage" style="font-size: 3rem; color: #1abc9c; margin-bottom: 1rem;"></i>
            <p style="color: #bdc3c7;">Promotions functionality will be available here</p>
          </div>
        </div>
      `;
    }

    function createSettingsContent() {
      return `
        <div style="padding: 2rem; text-align: center; color: #fff;">
          <h2 style="color: #34495e; margin-bottom: 1rem;">System Settings</h2>
          <p style="color: #bdc3c7; margin-bottom: 2rem;">Configure system preferences</p>
          <div style="background: rgba(52, 73, 94, 0.1); padding: 2rem; border-radius: 8px; border-left: 4px solid #34495e;">
            <i class="fas fa-cog" style="font-size: 3rem; color: #34495e; margin-bottom: 1rem;"></i>
            <p style="color: #bdc3c7;">Settings functionality will be available here</p>
          </div>
        </div>
      `;
    }

    function createPlaceholderContent(page) {
      return `
        <div style="padding: 2rem; text-align: center; color: #fff;">
          <h2 style="color: #95a5a6; margin-bottom: 1rem;">${page.charAt(0).toUpperCase() + page.slice(1)} Page</h2>
          <p style="color: #bdc3c7; margin-bottom: 2rem;">This page is under development</p>
          <div style="background: rgba(149, 165, 166, 0.1); padding: 2rem; border-radius: 8px; border-left: 4px solid #95a5a6;">
            <i class="fas fa-construction" style="font-size: 3rem; color: #95a5a6; margin-bottom: 1rem;"></i>
            <p style="color: #bdc3c7;">Content will be available soon</p>
          </div>
        </div>
      `;
    }

    function loadPageCSS(page) {
      // Remove any existing page-specific CSS
      const existingCSS = document.querySelector('link[data-page-css]');
      if (existingCSS) {
        existingCSS.remove();
      }
      
      // Try to add new page-specific CSS
      const cssLink = document.createElement('link');
      cssLink.rel = 'stylesheet';
      cssLink.href = `${page}.css`;
      cssLink.setAttribute('data-page-css', page);
      
      cssLink.onload = function() {
        console.log(`‚úÖ Successfully loaded CSS for ${page}`);
      };
      
      cssLink.onerror = function() {
        console.log(`‚ÑπÔ∏è CSS file ${page}.css not found (this is optional)`);
      };
      
      document.head.appendChild(cssLink);
    }

    function executePageScripts(container) {
      // Execute any scripts in the loaded content
      const scripts = container.querySelectorAll('script');
      console.log(`Found ${scripts.length} scripts to execute`);
      
      scripts.forEach((script, index) => {
        try {
          const newScript = document.createElement('script');
          
          if (script.src) {
            // External script
            newScript.src = script.src;
            newScript.onload = () => console.log(`Loaded external script ${index + 1}: ${script.src}`);
            newScript.onerror = () => console.log(`Failed to load external script ${index + 1}: ${script.src}`);
          } else {
            // Inline script
            newScript.textContent = script.textContent;
            console.log(`Executing inline script ${index + 1}`);
          }
          
          newScript.type = script.type || 'text/javascript';
          document.head.appendChild(newScript);
          
          // Remove the new script after execution to avoid duplicates
          setTimeout(() => {
            if (newScript.parentNode && !newScript.src) {
              newScript.parentNode.removeChild(newScript);
            }
          }, 100);
          
        } catch (error) {
          console.error(`Error executing script ${index + 1}:`, error);
        }
      });
    }

    function initializePageSpecificFeatures(page) {
      console.log(`üîß Initializing features for ${page} page`);
      
      // Page-specific initialization
      switch(page) {
        case 'suppliers':
          if (typeof window.initializeSuppliersPage === 'function') {
            window.initializeSuppliersPage();
            console.log(`‚úÖ Suppliers page initialized`);
          } else {
            console.log(`‚ö†Ô∏è initializeSuppliersPage function not found`);
          }
          break;
        default:
          console.log(`‚ÑπÔ∏è No specific initialization found for ${page}`);
      }
    }

    function updateDateTime() {
      const now = new Date();
      
      const timeOptions = {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      };
      
      const dateOptions = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      };
      
      // Update large center display
      const timeElement = document.getElementById('currentTimeLarge');
      const dateElement = document.getElementById('currentDateLarge');
      
      if (timeElement && dateElement) {
        timeElement.textContent = now.toLocaleTimeString('en-US', timeOptions);
        dateElement.textContent = now.toLocaleDateString('en-US', dateOptions);
      }
    }

    // Global functions for modal and file mode
    window.showSetupModal = function() {
      document.getElementById('setupModal').style.display = 'block';
    };

    window.closeSetupModal = function() {
      document.getElementById('setupModal').style.display = 'none';
    };

    window.enableFileMode = function() {
      window.FILE_MODE_ENABLED = true;
      const banner = document.getElementById('fileProtocolBanner');
      if (banner) {
        banner.remove();
        document.body.style.paddingTop = '0';
      }
      console.log('üîì File mode enabled - using embedded content');
    };

    // Make loadExternalPage available globally for retry button
    window.loadExternalPage = loadExternalPage;

    // Initialize dashboard on first load
    document.addEventListener('DOMContentLoaded', function() {
      // Hide header initially since dashboard is default
      document.getElementById('mainHeader').classList.add('hidden');
    });

    // Logout function
    window.logout = async function() {
      try {
        await signOut(auth);
        
        // Clear all session data
        localStorage.removeItem("userSession");
        localStorage.removeItem("authToken");
        localStorage.removeItem("selectedRole");
        localStorage.removeItem("selectedRoleName");
        localStorage.removeItem("sessionId");
        
        sessionStorage.removeItem("userSession");
        sessionStorage.removeItem("authToken");
        
        window.location.href = "selection.html";
        
      } catch (error) {
        console.error("Logout error:", error);
        window.location.href = "selection.html";
      }
    };
  </script>
</body>
</html>