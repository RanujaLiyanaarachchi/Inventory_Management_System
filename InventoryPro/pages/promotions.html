<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promotions | Inventory Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="promotion.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
</head>
<body>
    <div class="container">
        <main class="content">
            <header>
                <h1><i class="fas fa-tag"></i> Promotions Management</h1>
                <div class="user-actions">
                    <span>Welcome, Admin</span>
                    <button class="btn-logout"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <div class="promotion-controls">
                <button id="createPromoBtn" class="btn-primary">
                    <i class="fas fa-plus"></i> Create New Promotion
                </button>
                <div class="search-filter">
                    <input type="text" id="promoSearch" placeholder="Search promotions...">
                    <select id="statusFilter">
                        <option value="all">All Status</option>
                        <option value="active">Active</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="expired">Expired</option>
                    </select>
                </div>
            </div>

            <!-- Promotion Creation Modal -->
            <div id="promoModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Create New Promotion</h2>
                    <form id="promoForm">
                        <div class="form-group">
                            <label for="promoName">Promotion Name</label>
                            <input type="text" id="promoName" required>
                        </div>

                        <div class="form-group">
                            <label for="promoType">Promotion Type</label>
                            <select id="promoType" required>
                                <option value="">Select Type</option>
                                <option value="percentage">Percentage Discount</option>
                                <option value="fixed">Fixed Amount Discount</option>
                                <option value="bogo">Buy One Get One</option>
                                <option value="bundle">Bundle Discount</option>
                            </select>
                        </div>

                        <div class="form-group" id="discountValueGroup">
                            <label for="discountValue">Discount Value</label>
                            <input type="number" id="discountValue" min="0" step="0.01">
                            <span id="valueSymbol">%</span>
                        </div>

                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="datetime-local" id="startDate" required>
                        </div>

                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="datetime-local" id="endDate" required>
                        </div>

                        <div class="form-group">
                            <label>Apply To</label>
                            <div class="radio-group">
                                <label><input type="radio" name="applyTo" value="all" checked> All Products</label>
                                <label><input type="radio" name="applyTo" value="selected"> Selected Products</label>
                                <label><input type="radio" name="applyTo" value="categories"> Product Categories</label>
                            </div>
                        </div>

                        <div class="form-group" id="productSelection" style="display:none;">
                            <label>Select Products</label>
                            <div class="search-box">
                                <input type="text" id="productSearch" placeholder="Search products...">
                                <div id="productResults" class="search-results"></div>
                            </div>
                            <div id="selectedProducts" class="selected-items"></div>
                        </div>

                        <div class="form-group" id="categorySelection" style="display:none;">
                            <label>Select Categories</label>
                            <select id="promoCategories" multiple>
                                <option value="electronics">Electronics</option>
                                <option value="clothing">Clothing</option>
                                <option value="groceries">Groceries</option>
                                <option value="furniture">Furniture</option>
                                <option value="appliances">Appliances</option>
                                <option value="beauty">Beauty</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="minPurchase">Minimum Purchase Amount (optional)</label>
                            <input type="number" id="minPurchase" min="0" step="0.01">
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-secondary" id="cancelPromo">Cancel</button>
                            <button type="submit" class="btn-primary">Save Promotion</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Promotions List -->
            <div class="promotions-list">
                <table id="promotionsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Value</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Status</th>
                            <th>Applied To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated dynamically from Firebase -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Firebase and Firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Initialize Firebase with your config
        const firebaseConfig = {
            apiKey: "AIzaSyBKjE2SmRvgQczTmcKZrEFD0pyjLBMD4gg",
            authDomain: "inventorypro-lk.firebaseapp.com",
            projectId: "inventorypro-lk",
            storageBucket: "inventorypro-lk.appspot.com",
            messagingSenderId: "594998429191",
            appId: "1:594998429191:web:518f4b7f88eb7c0a2d0ca2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Promotion Types Configuration
        const promotionTypes = {
            percentage: { symbol: '%', label: 'Percentage Discount' },
            fixed: { symbol: 'Rs.', label: 'Fixed Amount Discount' },
            bogo: { symbol: '%', label: 'Buy One Get One' },
            bundle: { symbol: 'Rs.', label: 'Bundle Discount' }
        };

        // DOM Elements
        const promoModal = document.getElementById('promoModal');
        const createPromoBtn = document.getElementById('createPromoBtn');
        const closeModal = document.querySelector('.close');
        const cancelPromo = document.getElementById('cancelPromo');
        const promoForm = document.getElementById('promoForm');
        const promoType = document.getElementById('promoType');
        const discountValue = document.getElementById('discountValue');
        const valueSymbol = document.getElementById('valueSymbol');
        const applyToRadios = document.querySelectorAll('input[name="applyTo"]');
        const productSelection = document.getElementById('productSelection');
        const categorySelection = document.getElementById('categorySelection');
        const productSearch = document.getElementById('productSearch');
        const productResults = document.getElementById('productResults');
        const selectedProducts = document.getElementById('selectedProducts');
        const promoCategories = document.getElementById('promoCategories');
        const statusFilter = document.getElementById('statusFilter');
        const promoSearch = document.getElementById('promoSearch');
        const promotionsTable = document.getElementById('promotionsTable').getElementsByTagName('tbody')[0];

        // Global variables
        let allProducts = []; // Will store products from Firebase
        let promotions = []; // Will store promotions from Firebase
        let currentEditId = null; // Track which promotion is being edited

        // Event Listeners
        createPromoBtn.addEventListener('click', () => promoModal.classList.add('active'));
        closeModal.addEventListener('click', () => closeModalFunc());
        cancelPromo.addEventListener('click', () => closeModalFunc());
        window.addEventListener('click', (e) => e.target === promoModal ? closeModalFunc() : null);

        promoType.addEventListener('change', updateDiscountField);
        applyToRadios.forEach(radio => radio.addEventListener('change', updateApplyToFields));
        productSearch.addEventListener('input', searchProducts);
        promoForm.addEventListener('submit', handlePromoSubmit);
        statusFilter.addEventListener('change', filterPromotions);
        promoSearch.addEventListener('input', filterPromotions);

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadPromotions();
            updateDiscountField();
            updateApplyToFields();
        });

        // Load products from Firebase
        async function loadProducts() {
            try {
                const snapshot = await db.collection('products').get();
                allProducts = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('Products loaded:', allProducts);
            } catch (error) {
                console.error('Error loading products:', error);
                alert('Failed to load products: ' + error.message);
            }
        }

        // Load promotions from Firebase with real-time updates
        function loadPromotions() {
            db.collection('promotions').onSnapshot(snapshot => {
                promotions = [];
                snapshot.forEach(doc => {
                    const promoData = doc.data();
                    // Convert Firestore Timestamps to JavaScript Dates
                    const startDate = promoData.startDate.toDate();
                    const endDate = promoData.endDate.toDate();
                    
                    promotions.push({
                        id: doc.id,
                        ...promoData,
                        startDate,
                        endDate,
                        status: getPromoStatus(startDate, endDate)
                    });
                });
                renderPromotionsTable();
            }, error => {
                console.error('Error loading promotions:', error);
                alert('Failed to load promotions: ' + error.message);
            });
        }

        // Functions
        function closeModalFunc() {
            promoModal.classList.remove('active');
            promoForm.reset();
            selectedProducts.innerHTML = '';
            currentEditId = null;
        }

        function updateDiscountField() {
            const selectedType = promoType.value;
            if (selectedType && promotionTypes[selectedType]) {
                valueSymbol.textContent = promotionTypes[selectedType].symbol;
                document.getElementById('discountValueGroup').style.display = 'block';
                
                if (selectedType === 'bogo') {
                    discountValue.value = 50;
                    discountValue.readOnly = true;
                } else {
                    discountValue.readOnly = false;
                }
            } else {
                document.getElementById('discountValueGroup').style.display = 'none';
            }
        }

        function updateApplyToFields() {
            const applyToValue = document.querySelector('input[name="applyTo"]:checked').value;
            
            productSelection.style.display = applyToValue === 'selected' ? 'block' : 'none';
            categorySelection.style.display = applyToValue === 'categories' ? 'block' : 'none';
        }

        function searchProducts() {
            const searchTerm = productSearch.value.toLowerCase();
            if (searchTerm.length < 2) {
                productResults.innerHTML = '';
                productResults.style.display = 'none';
                return;
            }

            const filteredProducts = allProducts
                .filter(product => 
                    product.name.toLowerCase().includes(searchTerm) || 
                    (product.sku && product.sku.toLowerCase().includes(searchTerm))
                )
                .filter(product => !Array.from(selectedProducts.children).some(el => el.dataset.id == product.id));

            if (filteredProducts.length === 0) {
                productResults.innerHTML = '<div class="product-item">No products found</div>';
            } else {
                productResults.innerHTML = filteredProducts.map(product => `
                    <div class="product-item" data-id="${product.id}">
                        ${product.name} ${product.sku ? '(' + product.sku + ')' : ''} - ${product.category || 'No category'}
                        <button class="add-product">+ Add</button>
                    </div>
                `).join('');
            }

            productResults.style.display = 'block';

            document.querySelectorAll('.add-product').forEach(btn => {
                btn.addEventListener('click', addSelectedProduct);
            });
        }

        function addSelectedProduct(e) {
            const productItem = e.target.closest('.product-item');
            const productId = productItem.dataset.id;
            const product = allProducts.find(p => p.id === productId);

            const productElement = document.createElement('div');
            productElement.className = 'selected-item';
            productElement.dataset.id = productId;
            productElement.innerHTML = `
                ${product.name} ${product.sku ? '(' + product.sku + ')' : ''}
                <button class="remove-product">&times;</button>
            `;
            selectedProducts.appendChild(productElement);

            productItem.remove();
            if (document.querySelectorAll('.product-item').length === 0) {
                productResults.style.display = 'none';
            }

            productElement.querySelector('.remove-product').addEventListener('click', () => {
                productElement.remove();
            });
        }

        async function handlePromoSubmit(e) {
            e.preventDefault();
            
            // Get form values
            const name = document.getElementById('promoName').value;
            const type = document.getElementById('promoType').value;
            const value = parseFloat(document.getElementById('discountValue').value);
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const applyTo = document.querySelector('input[name="applyTo"]:checked').value;
            const minPurchase = document.getElementById('minPurchase').value ? 
                parseFloat(document.getElementById('minPurchase').value) : null;
            
            // Get selected products and categories
            const products = Array.from(selectedProducts.children).map(el => el.dataset.id);
            const categories = Array.from(promoCategories.selectedOptions).map(opt => opt.value);
            
            // Create promotion object for Firebase
            const promoData = {
                name,
                type,
                value,
                startDate: firebase.firestore.Timestamp.fromDate(startDate),
                endDate: firebase.firestore.Timestamp.fromDate(endDate),
                applyTo,
                products,
                categories,
                minPurchase,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (currentEditId) {
                    // Update existing promotion
                    await db.collection('promotions').doc(currentEditId).update(promoData);
                    alert('Promotion updated successfully!');
                } else {
                    // Add new promotion
                    await db.collection('promotions').add(promoData);
                    alert('Promotion created successfully!');
                }
                
                closeModalFunc();
            } catch (error) {
                console.error('Error saving promotion:', error);
                alert('Failed to save promotion: ' + error.message);
            }
        }

        function getPromoStatus(startDate, endDate) {
            const now = new Date();
            if (now < startDate) return "upcoming";
            if (now > endDate) return "expired";
            return "active";
        }

        function renderPromotionsTable() {
            promotionsTable.innerHTML = '';
            
            promotions.forEach(promo => {
                const row = document.createElement('tr');
                
                // Determine applied to text
                let appliedTo = '';
                if (promo.applyTo === 'all') {
                    appliedTo = 'All Products';
                } else if (promo.applyTo === 'categories') {
                    appliedTo = promo.categories.map(c => c.charAt(0).toUpperCase() + c.slice(1)).join(', ');
                } else {
                    const productNames = promo.products.map(id => {
                        const product = allProducts.find(p => p.id === id);
                        return product ? product.name : '';
                    }).filter(name => name);
                    appliedTo = productNames.join(', ') || 'Selected Products';
                }
                
                row.innerHTML = `
                    <td>${promo.name}</td>
                    <td>${promotionTypes[promo.type].label}</td>
                    <td>${promo.type === 'fixed' ? '$' : ''}${promo.value}${promo.type === 'percentage' ? '%' : ''}</td>
                    <td>${formatDate(promo.startDate)}</td>
                    <td>${formatDate(promo.endDate)}</td>
                    <td><span class="status-badge ${promo.status}">${promo.status.charAt(0).toUpperCase() + promo.status.slice(1)}</span></td>
                    <td>${appliedTo}</td>
                    <td>
                        <button class="btn-icon edit-promo" title="Edit" data-id="${promo.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn-icon delete-promo" title="Delete" data-id="${promo.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                
                promotionsTable.appendChild(row);
            });
            
            // Add event listeners to edit and delete buttons
            document.querySelectorAll('.edit-promo').forEach(btn => {
                btn.addEventListener('click', () => editPromotion(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-promo').forEach(btn => {
                btn.addEventListener('click', () => deletePromotion(btn.dataset.id));
            });
        }

        function formatDate(date) {
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        async function editPromotion(id) {
            const promo = promotions.find(p => p.id === id);
            if (!promo) return;
            
            currentEditId = id;
            
            // Fill the form with promotion data
            document.getElementById('promoName').value = promo.name;
            document.getElementById('promoType').value = promo.type;
            document.getElementById('discountValue').value = promo.value;
            document.getElementById('startDate').value = formatDateTimeLocal(promo.startDate);
            document.getElementById('endDate').value = formatDateTimeLocal(promo.endDate);
            document.querySelector(`input[name="applyTo"][value="${promo.applyTo}"]`).checked = true;
            document.getElementById('minPurchase').value = promo.minPurchase || '';
            
            // Update dependent fields
            updateDiscountField();
            updateApplyToFields();
            
            // Handle selected products
            selectedProducts.innerHTML = '';
            promo.products.forEach(productId => {
                const product = allProducts.find(p => p.id === productId);
                if (product) {
                    const productElement = document.createElement('div');
                    productElement.className = 'selected-item';
                    productElement.dataset.id = productId;
                    productElement.innerHTML = `
                        ${product.name} ${product.sku ? '(' + product.sku + ')' : ''}
                        <button class="remove-product">&times;</button>
                    `;
                    selectedProducts.appendChild(productElement);
                    
                    productElement.querySelector('.remove-product').addEventListener('click', () => {
                        productElement.remove();
                    });
                }
            });
            
            // Handle selected categories
            Array.from(promoCategories.options).forEach(option => {
                option.selected = promo.categories.includes(option.value);
            });
            
            // Show the modal
            promoModal.classList.add('active');
        }

        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        async function deletePromotion(id) {
            if (confirm('Are you sure you want to delete this promotion?')) {
                try {
                    await db.collection('promotions').doc(id).delete();
                    alert('Promotion deleted successfully!');
                } catch (error) {
                    console.error('Error deleting promotion:', error);
                    alert('Failed to delete promotion: ' + error.message);
                }
            }
        }

        function filterPromotions() {
            const searchTerm = promoSearch.value.toLowerCase();
            const statusFilterValue = statusFilter.value;
            
            const rows = promotionsTable.querySelectorAll('tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                const type = row.cells[1].textContent.toLowerCase();
                const status = row.cells[5].querySelector('.status-badge').textContent.toLowerCase();
                
                const matchesSearch = !searchTerm || name.includes(searchTerm) || type.includes(searchTerm);
                const matchesStatus = statusFilterValue === 'all' || status === statusFilterValue;
                
                if (matchesSearch && matchesStatus) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Show empty state if no matches
            if (visibleCount === 0 && promotions.length > 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = '<td colspan="8" style="text-align: center;">No promotions match your search criteria</td>';
                promotionsTable.appendChild(emptyRow);
            }
        }
    </script>
</body>
</html>