<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Products - InventoryPro</title>
    <meta
      name="description"
      content="Manage your product inventory efficiently with InventoryPro's product management system"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="products.css" />
  </head>
  <body>
    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <main class="products-container">
      <!-- Header Section -->
      <header class="products-header">
        <div class="header-controls">
          <!-- Search Input -->
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input
              type="text"
              placeholder="Search products..."
              class="search-input"
              id="productSearch"
            />
          </div>

          <!-- Category Filter -->
          <select
            class="filter-select"
            id="categoryFilter"
            title="Filter products by category"
          >
            <option value="">All Categories</option>
            <!-- Categories will be populated dynamically from database -->
          </select>

          <!-- Status Filter -->
          <select
            class="filter-select"
            id="statusFilter"
            title="Filter products by status"
          >
            <option value="">All Status</option>
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
          </select>

          <!-- Supplier Filter -->
          <select
            class="filter-select"
            id="supplierFilter"
            title="Filter products by supplier"
          >
            <option value="">All Suppliers</option>
            <!-- Suppliers will be populated dynamically from database -->
          </select>

          <!-- Add New Product Button -->
          <button class="btn-add-product" id="addProductBtn">
            <i class="fas fa-plus"></i>
            Add New Product
          </button>
        </div>
      </header>

      <!-- Products Table -->
      <section class="table-container">
        <div class="table-wrapper">
          <table class="products-table">
            <thead>
              <tr>
                <th class="col-id">Product ID</th>
                <th class="col-image">Image</th>
                <th class="col-name">Name</th>
                <th class="col-category">Category</th>
                <th class="col-supplier">Supplier</th>
                <th class="col-price">Price</th>
                <th class="col-stock">Stock</th>
                <th class="col-status">Status</th>
                <th class="col-actions">Actions</th>
              </tr>
            </thead>
            <tbody id="productsTableBody">
              <!-- Loading state -->
              <tr id="loadingRow">
                <td colspan="9" class="loading-cell">
                  <div class="loading-spinner"></div>
                  <p>Loading products...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Stats Summary -->
      <footer class="stats-summary">
        <div class="stat-item">
          <div class="stat-icon">
            <i class="fas fa-boxes"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="totalProducts">0</div>
            <div class="stat-label">Total Products</div>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-icon active">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="activeProducts">0</div>
            <div class="stat-label">Active</div>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-icon warning">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="lowStockProducts">0</div>
            <div class="stat-label">Low Stock</div>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-icon danger">
            <i class="fas fa-times-circle"></i>
          </div>
          <div class="stat-details">
            <div class="stat-value" id="outOfStockProducts">0</div>
            <div class="stat-label">Out of Stock</div>
          </div>
        </div>
      </footer>
    </main>

    <!-- Add/Edit Product Modal -->
    <div class="modal-overlay" id="productModal">
      <div class="modal-container">
        <div class="modal-content">
          <header class="modal-header">
            <h2 id="modalTitle">Add New Product</h2>
            <button
              class="close-btn"
              id="closeModal"
              type="button"
              title="Close modal"
            >
              <i class="fas fa-times"></i>
            </button>
          </header>
          <div class="modal-body">
            <form id="productForm" novalidate>
              <input type="hidden" id="productId" name="productId" />

              <!-- Image Upload Section -->
              <div class="image-upload-container">
                <div class="image-upload-preview" id="imagePreview">
                  <i class="fas fa-image"></i>
                  <button
                    type="button"
                    class="remove-image-btn"
                    id="removeImageBtn"
                    title="Remove image"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <label for="productImage" class="image-upload-btn">
                  <i class="fas fa-cloud-upload-alt"></i>
                  Upload Image
                </label>
                <input
                  type="file"
                  id="productImage"
                  name="productImage"
                  accept="image/*"
                  class="image-upload-input"
                />
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="productName">Product Name *</label>
                  <input
                    type="text"
                    id="productName"
                    name="productName"
                    required
                  />
                  <span class="error-message" id="productNameError"></span>
                </div>
                <div class="form-group">
                  <label for="productCategory">Category *</label>
                  <select id="productCategory" name="productCategory" required>
                    <option value="">Select Category</option>
                    <!-- Categories will be populated dynamically from database -->
                  </select>
                  <span class="error-message" id="productCategoryError"></span>
                </div>
                <div class="form-group">
                  <label for="productSupplier">Supplier *</label>
                  <select id="productSupplier" name="productSupplier" required>
                    <option value="">Select Supplier</option>
                  </select>
                  <span class="error-message" id="productSupplierError"></span>
                </div>
                <div class="form-group">
                  <label for="productPrice">Price *</label>
                  <div class="input-group">
                    <span class="input-prefix">$</span>
                    <input
                      type="number"
                      id="productPrice"
                      name="productPrice"
                      step="0.01"
                      min="0"
                      required
                      placeholder="0.00"
                    />
                  </div>
                  <span class="error-message" id="productPriceError"></span>
                </div>
                <div class="form-group">
                  <label for="productStock">Initial Stock</label>
                  <input
                    type="number"
                    id="productStock"
                    name="productStock"
                    min="0"
                    value="0"
                    placeholder="0"
                  />
                  <span class="error-message" id="productStockError"></span>
                </div>
                <div class="form-group">
                  <label for="productStatus">Status</label>
                  <select id="productStatus" name="productStatus">
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                  </select>
                  <span class="error-message" id="productStatusError"></span>
                </div>
                <div class="form-group full-width">
                  <label for="productDescription">Description</label>
                  <textarea
                    id="productDescription"
                    name="productDescription"
                    rows="3"
                    placeholder="Enter product description..."
                  ></textarea>
                  <span
                    class="error-message"
                    id="productDescriptionError"
                  ></span>
                </div>
              </div>
              <footer class="modal-actions">
                <button type="button" class="btn-cancel" id="cancelBtn">
                  Cancel
                </button>
                <button type="submit" class="btn-save" id="saveBtn">
                  <div class="btn-content">
                    <span class="btn-text">Save Product</span>
                  </div>
                  <div class="btn-loading">
                    <span class="loading-spinner"></span>
                    <span>Saving...</span>
                  </div>
                </button>
              </footer>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- View Product Details Modal -->
    <div class="modal-overlay" id="viewProductModal">
      <div class="modal-container">
        <div class="modal-content">
          <header class="modal-header">
            <h2>Product Details</h2>
            <button
              class="close-btn"
              id="closeViewModal"
              type="button"
              title="Close modal"
            >
              <i class="fas fa-times"></i>
            </button>
          </header>
          <div class="modal-body">
            <div class="product-details">
              <div class="product-image-section">
                <div class="product-image-large" id="viewProductImage">
                  <i class="fas fa-image"></i>
                </div>
              </div>
              <div class="product-info-section">
                <div class="details-grid">
                  <div class="detail-item">
                    <label>Product ID:</label>
                    <span id="viewProductId" data-product-id=""></span>
                  </div>
                  <div class="detail-item">
                    <label>Product Name:</label>
                    <span id="viewProductName"></span>
                  </div>
                  <div class="detail-item">
                    <label>Category:</label>
                    <span id="viewProductCategory"></span>
                  </div>
                  <div class="detail-item">
                    <label>Supplier:</label>
                    <span id="viewProductSupplier"></span>
                  </div>
                  <div class="detail-item">
                    <label>Price:</label>
                    <span id="viewProductPrice"></span>
                  </div>
                  <div class="detail-item">
                    <label>Stock Quantity:</label>
                    <span id="viewProductStock"></span>
                  </div>
                  <div class="detail-item">
                    <label>Status:</label>
                    <span id="viewProductStatus"></span>
                  </div>
                  <div class="detail-item full-width">
                    <label>Description:</label>
                    <span id="viewProductDescription"></span>
                  </div>
                  <div class="detail-item">
                    <label>Created Date:</label>
                    <span id="viewCreatedDate"></span>
                  </div>
                  <div class="detail-item">
                    <label>Last Updated:</label>
                    <span id="viewUpdatedDate"></span>
                  </div>
                </div>
              </div>
            </div>
            <footer class="modal-actions">
              <button type="button" class="btn-cancel" id="closeViewDetailsBtn">
                Close
              </button>
              <button type="button" class="btn-save" id="editFromViewBtn">
                <i class="fas fa-edit"></i>
                Edit Product
              </button>
            </footer>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
      <div class="modal-container">
        <div class="modal-content delete-modal">
          <header class="modal-header">
            <h2>Confirm Delete</h2>
            <button
              class="close-btn"
              id="closeDeleteModal"
              type="button"
              title="Close modal"
            >
              <i class="fas fa-times"></i>
            </button>
          </header>
          <div class="modal-body">
            <div class="delete-confirmation">
              <div class="delete-icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <h4>Are you sure you want to delete this product?</h4>
              <p>
                This action cannot be undone. The product "<span
                  id="deleteProductName"
                ></span
                >" will be permanently removed from your inventory.
              </p>
            </div>
            <footer class="modal-actions">
              <button type="button" class="btn-cancel" id="cancelDeleteBtn">
                Cancel
              </button>
              <button type="button" class="btn-delete" id="confirmDeleteBtn">
                <i class="fas fa-trash"></i>
                Delete Product
              </button>
            </footer>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // Import Firebase modules
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        doc,
        updateDoc,
        deleteDoc,
        query,
        orderBy,
        onSnapshot,
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytesResumable,
        getDownloadURL,
        deleteObject,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBKjE2SmRvgQczTmcKZrEFD0pyjLBMD4gg",
        authDomain: "inventorypro-lk.firebaseapp.com",
        projectId: "inventorypro-lk",
        storageBucket: "inventorypro-lk.firebasestorage.app",
        messagingSenderId: "594998429191",
        appId: "1:594998429191:web:518f4b7f88eb7c0a2d0ca2",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const storage = getStorage(app);

      // Global variables
      let products = [];
      let suppliers = [];
      let categories = [];
      let filteredProducts = [];
      let isFormSubmitting = false;
      let selectedImageFile = null;
      let currentImageUrl = null;

      // Toast notification system
      function showToast(message, type = "info", duration = 5000) {
        const toastContainer = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;

        const icon =
          type === "success"
            ? "check-circle"
            : type === "error"
            ? "exclamation-circle"
            : type === "warning"
            ? "exclamation-triangle"
            : "info-circle";

        toast.innerHTML = `
        <div class="toast-content">
          <i class="fas fa-${icon} toast-icon"></i>
          <span class="toast-message">${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;

        toastContainer.appendChild(toast);

        // Auto remove after duration
        setTimeout(() => {
          if (toast.parentElement) {
            toast.style.animation = "slideOutRight 0.3s ease-in-out forwards";
            setTimeout(() => toast.remove(), 300);
          }
        }, duration);

        // Animate in
        setTimeout(() => toast.classList.add("show"), 100);
      }

      // Initialize products page
      function initializeProductsPage() {
        console.log("üöÄ Products page initialized with Firebase!");
        initializeUI();
        initializeImageUpload();
        loadCategoriesFromFirebase();
        loadSuppliersFromFirebase();
        loadProductsFromFirebase();

        // Removed welcome toast message
      }

      function initializeUI() {
        // Modal elements
        const modal = document.getElementById("productModal");
        const viewModal = document.getElementById("viewProductModal");
        const deleteModal = document.getElementById("deleteModal");
        const addProductBtn = document.getElementById("addProductBtn");
        const closeModal = document.getElementById("closeModal");
        const closeViewModal = document.getElementById("closeViewModal");
        const closeDeleteModal = document.getElementById("closeDeleteModal");
        const cancelBtn = document.getElementById("cancelBtn");
        const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
        const closeViewDetailsBtn = document.getElementById(
          "closeViewDetailsBtn"
        );
        const editFromViewBtn = document.getElementById("editFromViewBtn");
        const productForm = document.getElementById("productForm");
        const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

        // Search and filter elements
        const searchInput = document.getElementById("productSearch");
        const categoryFilter = document.getElementById("categoryFilter");
        const statusFilter = document.getElementById("statusFilter");
        const supplierFilter = document.getElementById("supplierFilter");

        // Event listeners for modals
        addProductBtn?.addEventListener("click", openAddProductModal);
        closeModal?.addEventListener("click", closeModalFunc);
        cancelBtn?.addEventListener("click", closeModalFunc);
        closeViewModal?.addEventListener("click", closeViewModalFunc);
        closeDeleteModal?.addEventListener("click", closeDeleteModalFunc);
        closeViewDetailsBtn?.addEventListener("click", closeViewModalFunc);
        cancelDeleteBtn?.addEventListener("click", closeDeleteModalFunc);

        // Edit from view modal
        editFromViewBtn?.addEventListener("click", function () {
          const productId = document
            .getElementById("viewProductId")
            .getAttribute("data-product-id");
          closeViewModalFunc();
          editProduct(productId);
        });

        // Confirm delete
        confirmDeleteBtn?.addEventListener("click", confirmDelete);

        // Close modals when clicking outside
        modal?.addEventListener("click", function (e) {
          if (e.target === modal) closeModalFunc();
        });

        viewModal?.addEventListener("click", function (e) {
          if (e.target === viewModal) closeViewModalFunc();
        });

        deleteModal?.addEventListener("click", function (e) {
          if (e.target === deleteModal) closeDeleteModalFunc();
        });

        // Form submission
        productForm?.addEventListener("submit", function (e) {
          e.preventDefault();
          handleFormSubmission();
        });

        // Search and filter functionality
        searchInput?.addEventListener("input", debounce(filterProducts, 300));
        categoryFilter?.addEventListener("change", filterProducts);
        statusFilter?.addEventListener("change", filterProducts);
        supplierFilter?.addEventListener("change", filterProducts);

        // Action buttons event delegation
        document.addEventListener("click", handleActionButtons);

        // Keyboard shortcuts
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            if (modal?.classList.contains("active")) closeModalFunc();
            if (viewModal?.classList.contains("active")) closeViewModalFunc();
            if (deleteModal?.classList.contains("active"))
              closeDeleteModalFunc();
          }
        });

        // Modal close functions
        function closeModalFunc() {
          modal?.classList.remove("active");
          resetForm();
        }

        function closeViewModalFunc() {
          viewModal?.classList.remove("active");
        }

        function closeDeleteModalFunc() {
          deleteModal?.classList.remove("active");
        }
      }

      // Initialize image upload functionality
      function initializeImageUpload() {
        const imageInput = document.getElementById("productImage");
        const imagePreview = document.getElementById("imagePreview");
        const removeImageBtn = document.getElementById("removeImageBtn");

        imageInput?.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;

          if (!file.type.match("image.*")) {
            showToast("Please select an image file", "error");
            return;
          }

          selectedImageFile = file;
          const reader = new FileReader();

          reader.onload = function (e) {
            const img = document.createElement("img");
            img.src = e.target.result;

            // Clear previous preview content
            imagePreview.innerHTML = "";
            imagePreview.appendChild(img);

            // Show remove button
            removeImageBtn.style.display = "flex";
          };

          reader.readAsDataURL(file);
        });

        // Remove image button
        removeImageBtn?.addEventListener("click", function (e) {
          e.preventDefault();

          // Reset preview
          imagePreview.innerHTML = '<i class="fas fa-image"></i>';

          // Hide remove button
          removeImageBtn.style.display = "none";

          // Clear file input
          document.getElementById("productImage").value = "";

          // Clear selected file
          selectedImageFile = null;
          currentImageUrl = null;
        });
      }

      function handleActionButtons(e) {
        const button = e.target.closest(".action-btn");
        if (!button) return;

        e.preventDefault();
        const productId = button.getAttribute("data-product-id");

        if (button.classList.contains("view-btn")) {
          viewProduct(productId);
        } else if (button.classList.contains("edit-btn")) {
          editProduct(productId);
        } else if (button.classList.contains("delete-btn")) {
          deleteProduct(productId);
        }
      }

      // Load categories from Firebase
      function loadCategoriesFromFirebase() {
        console.log("üì• Loading categories from Firebase...");

        const categoriesRef = collection(db, "categories");
        const q = query(categoriesRef, orderBy("sortOrder", "asc"));

        onSnapshot(
          q,
          (querySnapshot) => {
            categories = [];
            querySnapshot.forEach((doc) => {
              const categoryData = doc.data();
              // Only include active categories
              if (categoryData.categoryStatus === "active") {
                categories.push({ id: doc.id, ...categoryData });
              }
            });

            console.log(
              `‚úÖ Loaded ${categories.length} active categories from Firebase`
            );
            populateCategoryDropdowns();
          },
          (error) => {
            console.error("‚ùå Error loading categories:", error);
            // Removed category loading error toast
          }
        );
      }

      function populateCategoryDropdowns() {
        const categoryFilter = document.getElementById("categoryFilter");
        const productCategory = document.getElementById("productCategory");

        // Clear existing options except the first one
        if (categoryFilter) {
          while (categoryFilter.children.length > 1) {
            categoryFilter.removeChild(categoryFilter.lastChild);
          }
        }

        if (productCategory) {
          while (productCategory.children.length > 1) {
            productCategory.removeChild(productCategory.lastChild);
          }
        }

        // Add categories to dropdowns
        categories.forEach((category) => {
          if (categoryFilter) {
            const option = document.createElement("option");
            option.value = category.categoryName;
            option.textContent = category.categoryName;
            categoryFilter.appendChild(option);
          }

          if (productCategory) {
            const option = document.createElement("option");
            option.value = category.categoryName;
            option.textContent = category.categoryName;
            productCategory.appendChild(option);
          }
        });
      }

      // Load suppliers from Firebase
      function loadSuppliersFromFirebase() {
        console.log("üì• Loading suppliers from Firebase...");

        const suppliersRef = collection(db, "suppliers");
        const q = query(suppliersRef, orderBy("createdAt", "desc"));

        onSnapshot(
          q,
          (querySnapshot) => {
            suppliers = [];
            querySnapshot.forEach((doc) => {
              suppliers.push({
                id: doc.id,
                ...doc.data(),
              });
            });

            console.log(
              `‚úÖ Loaded ${suppliers.length} suppliers from Firebase`
            );
            populateSupplierDropdowns();
          },
          (error) => {
            console.error("‚ùå Error loading suppliers:", error);
            // Removed supplier loading error toast
          }
        );
      }

      function populateSupplierDropdowns() {
        const supplierFilter = document.getElementById("supplierFilter");
        const productSupplier = document.getElementById("productSupplier");

        // Clear existing options
        supplierFilter.innerHTML = '<option value="">All Suppliers</option>';
        productSupplier.innerHTML = '<option value="">Select Supplier</option>';

        // Sort suppliers alphabetically by name
        const sortedSuppliers = [...suppliers].sort((a, b) =>
          (a.supplierName || "").localeCompare(b.supplierName || "")
        );

        sortedSuppliers.forEach((supplier) => {
          if (!supplier.supplierName) return;

          // For filter dropdown
          const filterOption = document.createElement("option");
          filterOption.value = supplier.id;
          filterOption.textContent = supplier.supplierName;
          supplierFilter.appendChild(filterOption);

          // For form dropdown
          const formOption = document.createElement("option");
          formOption.value = supplier.id;
          formOption.textContent = supplier.supplierName;
          productSupplier.appendChild(formOption);
        });
      }

      // Load products from Firebase
      function loadProductsFromFirebase() {
        console.log("üì• Loading products from Firebase...");

        const productsRef = collection(db, "products");
        const q = query(productsRef, orderBy("createdAt", "desc"));

        onSnapshot(
          q,
          (querySnapshot) => {
            products = [];
            querySnapshot.forEach((doc) => {
              products.push({
                id: doc.id,
                ...doc.data(),
              });
            });

            console.log(`‚úÖ Loaded ${products.length} products from Firebase`);
            filteredProducts = [...products];
            renderProducts();
            updateStats();
          },
          (error) => {
            console.error("‚ùå Error loading products:", error);
            renderEmptyState();
          }
        );
      }

      function openAddProductModal() {
        const modal = document.getElementById("productModal");

        document.getElementById("modalTitle").textContent = "Add New Product";
        resetForm();
        clearFormErrors();
        modal.classList.add("active");

        setTimeout(() => {
          document.getElementById("productName")?.focus();
        }, 100);
      }

      function resetForm() {
        const productForm = document.getElementById("productForm");
        productForm?.reset();
        document.getElementById("productId").value = "";

        // Reset image preview
        const imagePreview = document.getElementById("imagePreview");
        const removeImageBtn = document.getElementById("removeImageBtn");

        if (imagePreview) {
          imagePreview.innerHTML = '<i class="fas fa-image"></i>';
        }

        if (removeImageBtn) {
          removeImageBtn.style.display = "none";
        }

        selectedImageFile = null;
        currentImageUrl = null;
        isFormSubmitting = false;
        showButtonLoading(false);
      }

      function clearFormErrors() {
        const errorElements = document.querySelectorAll(".error-message");
        errorElements.forEach((element) => {
          element.textContent = "";
        });

        const inputElements = document.querySelectorAll(
          ".form-group input, .form-group select, .form-group textarea"
        );
        inputElements.forEach((element) => {
          element.classList.remove("error");
        });
      }

      function showFieldError(fieldName, message) {
        const errorElement = document.getElementById(`${fieldName}Error`);
        const inputElement = document.getElementById(fieldName);

        if (errorElement) errorElement.textContent = message;
        if (inputElement) inputElement.classList.add("error");
      }

      // View product details
      function viewProduct(productId) {
        const product = products.find((p) => p.id === productId);
        if (!product) {
          showToast("Product not found", "error");
          return;
        }

        const supplier = suppliers.find((s) => s.id === product.supplierId);
        const productIndex = filteredProducts.findIndex(
          (p) => p.id === productId
        );
        const productCode = `PRD${String(productIndex + 1).padStart(3, "0")}`;

        // Populate view modal
        document.getElementById("viewProductId").textContent = productCode;
        document
          .getElementById("viewProductId")
          .setAttribute("data-product-id", productId);
        document.getElementById("viewProductName").textContent =
          product.productName || "N/A";
        document.getElementById("viewProductCategory").textContent =
          product.productCategory || "N/A";
        document.getElementById("viewProductSupplier").textContent = supplier
          ? supplier.supplierName
          : "Unknown Supplier";
        document.getElementById(
          "viewProductPrice"
        ).textContent = `$${parseFloat(product.productPrice || 0).toFixed(2)}`;
        document.getElementById("viewProductStock").textContent = `${
          product.productStock || 0
        } units`;
        document.getElementById("viewProductStatus").textContent =
          product.productStatus || "N/A";
        document.getElementById("viewProductDescription").textContent =
          product.productDescription || "No description provided";

        // Display product image if available
        const viewProductImage = document.getElementById("viewProductImage");
        if (product.imageUrl) {
          viewProductImage.innerHTML = `<img src="${product.imageUrl}" alt="${product.productName}">`;
        } else {
          viewProductImage.innerHTML = '<i class="fas fa-image"></i>';
        }

        // Format dates
        const createdDate = product.createdAt
          ? formatDate(product.createdAt.toDate())
          : "N/A";
        const updatedDate = product.updatedAt
          ? formatDate(product.updatedAt.toDate())
          : "N/A";

        document.getElementById("viewCreatedDate").textContent = createdDate;
        document.getElementById("viewUpdatedDate").textContent = updatedDate;

        // Show view modal
        document.getElementById("viewProductModal").classList.add("active");
      }

      // Edit product
      function editProduct(productId) {
        const product = products.find((p) => p.id === productId);
        if (!product) {
          showToast("Product not found", "error");
          return;
        }

        clearFormErrors();
        document.getElementById("modalTitle").textContent = "Edit Product";
        document.getElementById("productId").value = productId;
        document.getElementById("productName").value =
          product.productName || "";
        document.getElementById("productCategory").value =
          product.productCategory || "";
        document.getElementById("productSupplier").value =
          product.supplierId || "";
        document.getElementById("productPrice").value =
          product.productPrice || "";
        document.getElementById("productStock").value =
          product.productStock || 0;
        document.getElementById("productStatus").value =
          product.productStatus || "Active";
        document.getElementById("productDescription").value =
          product.productDescription || "";

        // Set image preview if available
        if (product.imageUrl) {
          const imagePreview = document.getElementById("imagePreview");
          const removeImageBtn = document.getElementById("removeImageBtn");

          imagePreview.innerHTML = `<img src="${product.imageUrl}" alt="${product.productName}">`;
          removeImageBtn.style.display = "flex";
          currentImageUrl = product.imageUrl;
        }

        document.getElementById("productModal").classList.add("active");

        setTimeout(() => {
          document.getElementById("productName")?.focus();
        }, 100);
      }

      // Delete product
      function deleteProduct(productId) {
        const product = products.find((p) => p.id === productId);
        if (!product) {
          showToast("Product not found", "error");
          return;
        }

        document.getElementById("deleteProductName").textContent =
          product.productName || "Unnamed Product";
        document
          .getElementById("confirmDeleteBtn")
          .setAttribute("data-product-id", productId);
        document.getElementById("deleteModal").classList.add("active");
      }

      async function confirmDelete() {
        const deleteBtn = document.getElementById("confirmDeleteBtn");
        const productId = deleteBtn.getAttribute("data-product-id");
        if (!productId) return;

        const originalContent = deleteBtn.innerHTML;

        deleteBtn.disabled = true;
        deleteBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Deleting...';

        try {
          const product = products.find((p) => p.id === productId);

          // Delete image from storage if exists
          if (product && product.imageUrl) {
            try {
              const imageRef = ref(storage, product.imageUrl);
              await deleteObject(imageRef);
              console.log("Image deleted successfully");
            } catch (imageError) {
              console.error("Error deleting image:", imageError);
              // Continue with product deletion even if image deletion fails
            }
          }

          // Delete product document
          await deleteDoc(doc(db, "products", productId));
          showToast("Product deleted successfully!", "success");
          document.getElementById("deleteModal").classList.remove("active");
        } catch (error) {
          console.error("‚ùå Error deleting product:", error);
          showToast("Failed to delete product. Please try again.", "error");
        } finally {
          deleteBtn.disabled = false;
          deleteBtn.innerHTML = originalContent;
        }
      }

      // Handle form submission
      async function handleFormSubmission() {
        if (isFormSubmitting) return;

        clearFormErrors();
        isFormSubmitting = true;

        const formData = new FormData(document.getElementById("productForm"));
        const productId = formData.get("productId");

        // Validation
        let hasErrors = false;

        const productName = formData.get("productName").trim();
        if (!productName) {
          showFieldError("productName", "Product name is required");
          hasErrors = true;
        }

        const productCategory = formData.get("productCategory");
        if (!productCategory) {
          showFieldError("productCategory", "Category is required");
          hasErrors = true;
        }

        const productSupplier = formData.get("productSupplier");
        if (!productSupplier) {
          showFieldError("productSupplier", "Supplier is required");
          hasErrors = true;
        }

        const productPrice = parseFloat(formData.get("productPrice"));
        if (isNaN(productPrice) || productPrice <= 0) {
          showFieldError(
            "productPrice",
            "Please enter a valid price greater than 0"
          );
          hasErrors = true;
        }

        const productStock = parseInt(formData.get("productStock"));
        if (isNaN(productStock) || productStock < 0) {
          showFieldError("productStock", "Please enter a valid stock quantity");
          hasErrors = true;
        }

        if (hasErrors) {
          isFormSubmitting = false;
          showToast("Please fix the errors in the form", "error");
          return;
        }

        showButtonLoading(true);

        try {
          let imageUrl = currentImageUrl;

          // Upload image if selected
          if (selectedImageFile) {
            showToast("Uploading image...", "info", 2000);

            // Create a storage reference
            const storageRef = ref(
              storage,
              `products/${Date.now()}_${selectedImageFile.name}`
            );

            // Upload the file
            const uploadTask = uploadBytesResumable(
              storageRef,
              selectedImageFile
            );

            // Wait for upload to complete and get download URL
            await new Promise((resolve, reject) => {
              uploadTask.on(
                "state_changed",
                (snapshot) => {
                  // Track upload progress if needed
                  const progress =
                    (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                  console.log(`Upload progress: ${progress.toFixed(2)}%`);
                },
                (error) => {
                  console.error("Upload error:", error);
                  reject(error);
                },
                async () => {
                  try {
                    imageUrl = await getDownloadURL(uploadTask.snapshot.ref);
                    resolve();
                  } catch (urlError) {
                    reject(urlError);
                  }
                }
              );
            });
          }

          // If current image was removed but no new image selected
          if (currentImageUrl && !imageUrl && !selectedImageFile) {
            // Delete old image from storage
            try {
              const oldImageRef = ref(storage, currentImageUrl);
              await deleteObject(oldImageRef);
            } catch (error) {
              console.error("Error deleting old image:", error);
              // Continue with product update even if image deletion fails
            }
          }

          const productData = {
            productName: productName,
            productCategory: productCategory,
            supplierId: productSupplier,
            productPrice: productPrice,
            productStock: productStock,
            productStatus: formData.get("productStatus"),
            productDescription:
              formData.get("productDescription")?.trim() || "",
            updatedAt: Timestamp.now(),
          };

          // Only add imageUrl field if we have one
          if (imageUrl) {
            productData.imageUrl = imageUrl;
          } else if (imageUrl === null && currentImageUrl) {
            // This means image was explicitly removed
            productData.imageUrl = null;
          }

          if (productId) {
            const productRef = doc(db, "products", productId);
            await updateDoc(productRef, productData);
            showToast("Product updated successfully!", "success");
          } else {
            productData.createdAt = Timestamp.now();
            await addDoc(collection(db, "products"), productData);
            showToast("Product added successfully!", "success");
          }

          document.getElementById("productModal").classList.remove("active");
          resetForm();
        } catch (error) {
          console.error("‚ùå Error saving product:", error);
          showToast("Failed to save product. Please try again.", "error");
        } finally {
          showButtonLoading(false);
          isFormSubmitting = false;
        }
      }

      // Filter products
      function filterProducts() {
        const searchTerm =
          document.getElementById("productSearch")?.value?.toLowerCase() || "";
        const categoryValue =
          document.getElementById("categoryFilter")?.value || "";
        const statusValue =
          document.getElementById("statusFilter")?.value || "";
        const supplierValue =
          document.getElementById("supplierFilter")?.value || "";

        filteredProducts = products.filter((product) => {
          const supplier = suppliers.find((s) => s.id === product.supplierId);
          const supplierName = supplier
            ? supplier.supplierName.toLowerCase()
            : "";

          const matchesSearch =
            (product.productName || "").toLowerCase().includes(searchTerm) ||
            (product.productCategory || "")
              .toLowerCase()
              .includes(searchTerm) ||
            supplierName.includes(searchTerm);

          const matchesCategory =
            !categoryValue || product.productCategory === categoryValue;
          const matchesStatus =
            !statusValue || product.productStatus === statusValue;
          const matchesSupplier =
            !supplierValue || product.supplierId === supplierValue;

          return (
            matchesSearch && matchesCategory && matchesStatus && matchesSupplier
          );
        });

        renderProducts();
      }

      // Render products table
      function renderProducts() {
        const tableBody = document.getElementById("productsTableBody");
        const loadingRow = document.getElementById("loadingRow");

        if (loadingRow) {
          loadingRow.remove();
        }

        tableBody.innerHTML = "";

        if (filteredProducts.length === 0) {
          if (products.length === 0) {
            renderEmptyState();
          } else {
            tableBody.innerHTML = `
            <tr>
              <td colspan="9" class="no-results">
                <i class="fas fa-search"></i>
                <p>No products match your search criteria.</p>
                <button onclick="clearFilters()" class="btn-clear">Clear Filters</button>
              </td>
            </tr>
          `;
          }
          return;
        }

        filteredProducts.forEach((product, index) => {
          const productCode = `PRD${String(index + 1).padStart(3, "0")}`;
          const supplier = suppliers.find((s) => s.id === product.supplierId);
          const supplierName = supplier
            ? supplier.supplierName
            : "Unknown Supplier";
          const category = categories.find(
            (c) => c.categoryName === product.productCategory
          );

          const stockClass = getStockClass(product.productStock || 0);
          const statusClass = (
            product.productStatus || "inactive"
          ).toLowerCase();
          const categoryClass = getCategoryClass(product.productCategory || "");

          const row = document.createElement("tr");
          row.setAttribute("data-product-id", product.id);
          row.className = "table-row";

          // Image cell content with actual image if available
          let imageCell = `
          <div class="image-placeholder">
            <i class="fas fa-image"></i>
          </div>
        `;

          if (product.imageUrl) {
            imageCell = `
            <div class="image-placeholder">
              <img src="${product.imageUrl}" alt="${
              product.productName || "Product"
            }">
            </div>
          `;
          }

          // Category cell with image support
          let categoryCell = `
          <span class="category-badge ${categoryClass}" title="${
            product.productCategory || "Uncategorized"
          }">
            ${product.productCategory || "Uncategorized"}
          </span>
        `;

          if (category && category.categoryImage) {
            categoryCell = `
            <div class="category-with-image">
              <img src="${category.categoryImage}" alt="${category.categoryName}" class="category-image">
              <span class="category-badge ${categoryClass}" title="${product.productCategory}">
                ${product.productCategory}
              </span>
            </div>
          `;
          }

          row.innerHTML = `
          <td class="col-id">
            <span class="product-id">${productCode}</span>
          </td>
          <td class="col-image">${imageCell}</td>
          <td class="col-name">
            <span class="product-name" title="${
              product.productName || "Unnamed Product"
            }">${product.productName || "Unnamed Product"}</span>
          </td>
          <td class="col-category">
            ${categoryCell}
          </td>
          <td class="col-supplier">
            <span class="supplier-name" title="${supplierName}">${supplierName}</span>
          </td>
          <td class="col-price">
            <span class="product-price">$${parseFloat(
              product.productPrice || 0
            ).toFixed(2)}</span>
          </td>
          <td class="col-stock">
            <div class="stock-container">
              <span class="stock-value ${stockClass}">${
            product.productStock || 0
          }</span>
              <span class="stock-unit">units</span>
            </div>
          </td>
          <td class="col-status">
            <span class="status-badge ${statusClass}">
              ${product.productStatus || "Inactive"}
            </span>
          </td>
          <td class="col-actions">
            <div class="actions">
              <button class="action-btn view-btn" title="View Details" data-product-id="${
                product.id
              }" type="button">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn edit-btn" title="Edit Product" data-product-id="${
                product.id
              }" type="button">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn delete-btn" title="Delete Product" data-product-id="${
                product.id
              }" type="button">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        `;

          tableBody.appendChild(row);
        });
      }

      // Render empty state
      function renderEmptyState() {
        const tableBody = document.getElementById("productsTableBody");
        tableBody.innerHTML = `
        <tr>
          <td colspan="9" class="empty-state">
            <i class="fas fa-box"></i>
            <h3>No Products Found</h3>
            <p>Get started by adding your first product to the inventory.</p>
            <button onclick="document.getElementById('addProductBtn').click()" class="btn-add-first">
              <i class="fas fa-plus"></i>
              Add First Product
            </button>
          </td>
        </tr>
      `;
      }

      function updateStats() {
        const totalProducts = products.length;
        const activeProducts = products.filter(
          (p) => p.productStatus === "Active"
        ).length;
        const lowStockProducts = products.filter((p) => {
          const stock = parseInt(p.productStock) || 0;
          return stock <= 10 && stock > 0;
        }).length;
        const outOfStockProducts = products.filter((p) => {
          const stock = parseInt(p.productStock) || 0;
          return stock === 0;
        }).length;

        animateCountUp("totalProducts", totalProducts);
        animateCountUp("activeProducts", activeProducts);
        animateCountUp("lowStockProducts", lowStockProducts);
        animateCountUp("outOfStockProducts", outOfStockProducts);
      }

      function animateCountUp(elementId, targetValue) {
        const element = document.getElementById(elementId);
        if (!element) return;

        const currentValue = parseInt(element.textContent) || 0;
        if (currentValue === targetValue) return;

        const increment = targetValue > currentValue ? 1 : -1;
        let current = currentValue;

        const interval = setInterval(() => {
          current += increment;
          element.textContent = current;

          if (current === targetValue) {
            clearInterval(interval);
          }
        }, 50);
      }

      // Utility functions
      function getStockClass(stock) {
        const stockNum = parseInt(stock) || 0;
        if (stockNum === 0) return "out-of-stock";
        if (stockNum <= 10) return "low-stock";
        return "normal-stock";
      }

      function getCategoryClass(category) {
        if (!category) return "uncategorized";
        return category.toLowerCase().replace(/\s+/g, "-").replace(/&/g, "");
      }

      function formatDate(date) {
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // Updated button loading function with enhanced DOM manipulation
      function showButtonLoading(loading) {
        const saveBtn = document.getElementById("saveBtn");
        
        if (!saveBtn) return;
        
        if (loading) {
          // Apply loading state
          saveBtn.classList.add("loading");
          saveBtn.disabled = true;
          
          // Ensure the loading spinner is displayed
          const loadingEl = saveBtn.querySelector(".btn-loading");
          if (loadingEl) {
            loadingEl.style.display = "flex";
          }
          
          // Hide the button content
          const contentEl = saveBtn.querySelector(".btn-content");
          if (contentEl) {
            contentEl.style.opacity = "0";
            contentEl.style.visibility = "hidden";
          }
        } else {
          // Remove loading state
          saveBtn.classList.remove("loading");
          saveBtn.disabled = false;
          
          // Hide the loading spinner
          const loadingEl = saveBtn.querySelector(".btn-loading");
          if (loadingEl) {
            loadingEl.style.display = "";
          }
          
          // Show the button content
          const contentEl = saveBtn.querySelector(".btn-content");
          if (contentEl) {
            contentEl.style.opacity = "";
            contentEl.style.visibility = "";
          }
        }
      }

      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Global functions
      window.clearFilters = function () {
        document.getElementById("productSearch").value = "";
        document.getElementById("categoryFilter").value = "";
        document.getElementById("statusFilter").value = "";
        document.getElementById("supplierFilter").value = "";
        filterProducts();
      };

      // Initialize page
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializeProductsPage);
      } else {
        initializeProductsPage();
      }
    </script>
  </body>
</html>
